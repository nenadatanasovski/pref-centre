<script runat="server">
   Platform.Load("Core", "1");
   
   var qs = Platform.Request.GetQueryStringParameter('qs');
   var e = Platform.Request.GetQueryStringParameter('e');
   
   if (qs == null && e == null) { Platform.Response.Redirect('https://pub.s7.exacttarget.com/l3k2j4guogq');}
   
   if (!qs == null) {
    var environment = 'emailSend';
    var subscriberKey = Attribute.GetValue("_subscriberkey");
    var subscriberId = Attribute.GetValue("subscriberid");
    var emailAddress = Attribute.GetValue("emailaddr");
    var jid = Attribute.GetValue("jobid");
    var lid = Attribute.GetValue("ListID");
    var bid = Attribute.GetValue("_JobSubscriberBatchID");
   } else if (!e == null) {
    var unhashUrl = Platform.Function.Base64Decode(e);
    var hashedEmailNoSecret = unhashUrl.replace("8f70H91g67Tijw4", "");
    var emailAddress = Platform.Function.Base64Decode(hashedEmailNoSecret);
    if (emailAddress.indexOf("@") == -1 ) {
    		Platform.Response.Redirect('https://pub.s7.exacttarget.com/l3k2j4guogq');
    }
    var environment = 'manualRedirect';
    var subscriberKey = emailAddress;
   }  
   
   var allSubRows = Platform.Function.LookupRows('parent_level_subscribers',['EmailAddress'],[emailAddress]);
   if (allSubRows.length > 0) {
   		var addSub = 0;
   } else {
    var addSubscriber = {
    "EmailAddress": emailAddress,
    "SubscriberKey": emailAddress
   }
   var status = Subscriber.Add(addSubscriber);
   }
   
   var method = Platform.Request.Method();
   var mySubs = DataExtension.Init("NRL_subscribers");
   var mySub = {};
   
   if (method == 'GET') { initialise(); } else if (method == 'POST') { if (updatePrefs() > 0) { initialise();}
   } else {
       Platform.Variable.SetValue('@invalid', 'your preferences are updated');
   }
   
   function initialise() {
       try {
           mySub = mySubs.Rows.Lookup(["email_address"], [subscriberKey])[0];
       } catch (e) {
           Platform.Variable.SetValue("@invalid", 1);
       }
   }
   
   function updatePrefs() {
       try {
           var fields = ['newsletter', 'nrl_partners', 'participation', 'SMS','Unsubscribed','updated_date','status'];
           var values = [
               Request.GetFormField('newsletter') ? Request.GetFormField('newsletter') : "0",
               Request.GetFormField('nrl_partners') ? Request.GetFormField('nrl_partners') : "0",
               Request.GetFormField('participation') ? Request.GetFormField('participation') : "0",
               Request.GetFormField('SMS') ? Request.GetFormField('SMS') : "0",
               Request.GetFormField('Unsubscribed') ? Request.GetFormField('Unsubscribed') : "0",
               Platform.Function.SystemDateToLocalDate(new Date())
           ];
   
           // If Unsub from All Selected add status field to update and execute LogUnsubEvent through API
           if (Request.GetFormField('Unsubscribed') == "1") {
               values.push('Unsubscribed');
               if (!logUnsub()) {
                   Platform.Variable.SetValue("@invalid", 1);
                   return null;
               }
           } else {
               // Get the All Subscribers record for this subscriber. The mailable status needs
               // retrieving to understand whether we need to resubscribe
               values.push('Active');
               if (!resubscribe()) {
                   Platform.Variable.SetValue("@invalid", 1);
                   return null;
               }
           }
   
           var rows = Platform.Function.UpsertData("NRL_subscribers", ["email_address"], [emailAddress], fields, values);
           Platform.Variable.SetValue("@statusMessage", "your preferences are updated");
       } catch (e) {
           Platform.Variable.SetValue("@invalid", 1);
           return null;
       }
   }
   
   function resubscribe() {
       try {
           var subscriber = {
               "Status": "Active"
           };
           var subObj = Subscriber.Init(subscriberKey);
           var status = subObj.Update(subscriber);
           return true;
       } catch (e) {
           return false;
       }
   }
   
   function logUnsub() {
       // SSJS API Code - long winded. Need to consider new WSProxy for tidier code
       try {
           lue = Platform.Function.CreateObject("ExecuteRequest");
           Platform.Function.SetObjectProperty(lue, "Name", "LogUnsubEvent");
   
           lue_prop = Platform.Function.CreateObject("APIProperty");
           Platform.Function.SetObjectProperty(lue_prop, "Name", "SubscriberKey");
           Platform.Function.SetObjectProperty(lue_prop, "Value", subscriberKey);
           Platform.Function.AddObjectArrayItem(lue, "Parameters", lue_prop);
   
           lue_prop = Platform.Function.CreateObject("APIProperty");
           Platform.Function.SetObjectProperty(lue_prop, "Name", "JobID");
           Platform.Function.SetObjectProperty(lue_prop, "Value", jid);
           Platform.Function.AddObjectArrayItem(lue, "Parameters", lue_prop);
   
           lue_prop = Platform.Function.CreateObject("APIProperty");
           Platform.Function.SetObjectProperty(lue_prop, "Name", "ListID");
           Platform.Function.SetObjectProperty(lue_prop, "Value", lid);
           Platform.Function.AddObjectArrayItem(lue, "Parameters", lue_prop);
   
           lue_prop = Platform.Function.CreateObject("APIProperty");
           Platform.Function.SetObjectProperty(lue_prop, "Name", "BatchID");
           Platform.Function.SetObjectProperty(lue_prop, "Value", bid);
           Platform.Function.AddObjectArrayItem(lue, "Parameters", lue_prop);
   
           lue_prop = Platform.Function.CreateObject("APIProperty");
           Platform.Function.SetObjectProperty(lue_prop, "Name", "Reason");
           Platform.Function.SetObjectProperty(lue_prop, "Value", "One-Click Unsubscribe");
           Platform.Function.AddObjectArrayItem(lue, "Parameters", lue_prop);
   
           var statusAndRequest = [0, 0];
           Response = Platform.Function.InvokeExecute(lue, statusAndRequest);
       } catch (err) {
           return false;
       }
   
       return true;
   }
   
   function prefChecked(prefName) {
       if (mySub[prefName]) {
           return 'checked';
       } else {
           return '';
       }
   }
   
   Platform.Variable.SetValue("@environment",environment);
   Platform.Variable.SetValue("@e",emailAddress);  
   
</script>
<html>
   <head>
      <title>NRL Preference Centre</title>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
   </head>
   <link href="http://image.nrl.com/lib/fe90137276650c7f7d/m/1/c62980d6-7fba-44a8-94c5-c967e0218bb7.png" rel="SHORTCUT ICON" type="image/png" />
   <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet" />
   <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
   <style type="text/css">
      html {
      font-family: 'Source Sans Pro', sans-serif;
      font-size: 1rem;
      line-height: 1.15rem;
      }
      header {
      margin:10px 0px 10px 20px;
      }
      body {
      padding: 0px;
      margin: 0px;
      border: 0px;
      background-color: #f6f6f6;
      }
      h2 {
      padding-top: 10px;
      text-transform: uppercase;
      color : #222222;
      letter-spacing :2px;
      font-weight: 700;
      font-size: calc(1.125rem + 6 * (100vw - 320px) / 1280);
      }
      h3 {
      padding-top: 10px;
      text-transform: uppercase;
      color : #222222;
      letter-spacing :2px;
      font-weight: 700;
      font-size: calc(1.125rem + 6 * (100vw - 320px) / 1280);
      text-align: center;
      }
      label {
      font-weight: 600;
      line-height: 1.5;
      }
      div.content{
      text-align: center;
      max-width:85%;
      margin: 1rem auto 1.5rem;
      }
      div.content img.logo{
      width:10%;
      }
      div.block-title{
      min-width: 400px;
      max-width: 960px;
      text-align: left;
      margin:30px auto 0px;
      }
      div.content-wrapper{
      min-width: 400px;
      max-width: 900px;
      text-align: left;
      margin: 0px auto;
      padding: 10px 30px;
      background-color:#FFF;
      box-shadow: 0 0.125rem 0.5rem 0.125rem rgba(0,0,0,.04);
      }
      div.content-wrapper p {
      font-size: 0.875rem;
      }
      div.content-wrapper p.updated{
      color:#007041;
      font-width:bold;
      }
      div.preference {
      display: block;
      margin: 20px 0px;
      }
      div.preference .options {
      width: 100%;
      border-top: 1px solid #007041;
      display: block;
      }
      div.preference .options h2 {
      font-size: 1.5rem;
      font-weight: bold;
      }
      td.name-cell{
      vertical-align: middle;
      }  
      img.bu-icon{
      height: 10rem;
      width: 10rem;
      } 
      div.preference .options ul {
      margin: 0px;
      padding-left: 0px;
      list-style: none;
      }
      div.preference .options li label.Picklist
      {
      margin:0px 18px;
      }   
      .help-text {
      color: #888;
      font-size: 0.875rem;
      }
      div.preference .options li.new:after
      {
      content:"new";
      color: #F00;
      font-size: 0.8em;
      display: inline-block;
      padding: 0px 5px;
      }   
      select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      font-size: 0.875rem;
      font-family: 'Source Sans Pro', sans-serif;
      color: #00874f;
      border-left: 0;
      border-right: 0;
      border-top: 0;
      border-bottom: .125rem solid #d8d8d8;
      border-top-left-radius: 0px;
      border-top-right-radius: 0px;
      border-bottom-left-radius: 0px !important;
      border-bottom-right-radius: 0px !important;
      background-color: #fff;
      min-height: 2rem;
      }    
      .action-centre {
      margin: auto;
      text-align: center!important;
      }   
      .buttons {
      max-width: 30rem;
      margin-top: 1.5rem!important;
      margin-left: auto;
      margin-right: auto;
      } 
      .save-button {
      border-radius: 4px;
      border: 0px;
      padding: 20px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      letter-spacing: 0.125rem;
      text-transform: uppercase;
      background: #008540;
      width: 100%;
      transition: all .25s ease-out;
      }
      .save-button:hover {      
      background: #00CF5D;
      color:#FFFFFF;
      }
      a {
      color: #00874f; 
      } 
      a.cancel {
      color: #00874f;
      text-decoration: none;
      font-weight: 600;
      letter-spacing: 0.125rem;
      text-transform: uppercase;
      display: inline-block;
      width: auto;
      margin-top: .3rem;
      margin-bottom: .3rem;
      padding: .4375rem;
      transition: all .25s ease-out;
      }
      a.cancel:hover {
      color: #FFFFFF;
      cursor: pointer;
      }
      .privacy-notices {
      margin-left: auto;
      margin-right: auto;
      text-align: center!important;
      max-width: 30rem;
      font-size: 0.875rem;
      line-height: 1;
      }
      .o-content-link {
      text-decoration: underline;
      color: #005447;
      }
      .o-content-link:hover {
      text-decoration: none;
      color: #00874f;
      }
      .pref-center_bu-name {
      color: #000;
      font-weight: 600;
      }
      .pref-centre_help-text {
      color: #888;
      margin-top: 1rem;
      }
      footer {
      padding-right: 2px;
      padding-left: 2px;	
	  bottom: 0;

	  position: absolute;
	  width: 100%
	  }
      footer .app-links img {
      vertical-align: top
      }
      footer .app-links img.android {
      height: 1.0625rem
      }
      footer .app-links img.apple {
      height: 1rem
      }
      footer .app-links,
      footer .help-link,
      footer .home-link {
      float: left;
      margin-right: 1.25rem
      }
      footer .social-links {
      float: right;
      margin-top: 0.375rem
      }
      footer .social-links a {
      background: white;
      border-radius: 50%;
      box-shadow: 0 0 0 0.125rem rgba(135, 116, 138, 0.08);
      float: left;
      height: 2.5rem;
      width: 2.5rem
      }
      footer .social-links a:not(:first-child) {
      margin-left: 1.25rem
      }
      footer .social-links a img {
      display: block;
      left: 50%;
      position: relative;
      top: 50%
      }
      footer .social-links a img.facebook,
      footer .social-links a img.twitter {
      height: 1.25rem;
      margin: -0.625rem 0 0 -0.625rem
      }
      footer .social-links a img.instagram {
      height: 1.125rem;
      margin: -0.5625rem 0 0 -0.5625rem
      }
      footer .social-links a img.youtube {
      height: 1.375rem;
      margin: -0.6875rem 0 0 -0.6875rem
      }
      footer .copyright {
      font-size: 13px;
      font-weight: normal;
      letter-spacing: -0.5px;
      line-height: 1.85;
      clear: left;
      color: #7d6581;
      float: left;
      margin-top: 0.5rem
      }
      diva[href]:not([href='#']) {
      font-size: 15px;
      font-weight: normal;
      letter-spacing: -0.6px;
      line-height: 1.333333
      }
   </style>
   <body>
      <div class="content">
         <div class="block-title">
            <table>
               <tr>
                  <td class="icon-cell"><img src="https://www.nrl.com/client/dist/logos/nrl-badge.svg?1" class="bu-icon"/></td>
                  <td>
                     <h2>
                        NRL commmunication Preferences <br>
                        environment: %%=v(@environment)=%% <br>
                        email: %%=v(@e)=%% <br>
                        statusMessage: %%=v(@statusMessage)=%%
                     </h2>
                  </td>
               </tr>
            </table>
         </div>
         <div class="content-wrapper">
            %%[ IF NOT EMPTY(@statusMessage) THEN ]%%
            <div class="action-centre">
               <h3>Updated preferences for <b>%%=v(@e)=%%</b></h3>
            </div>
            %%[ ENDIF ]%%
            <br>
            <p class="explainer">Select the content you would like to subscribe to.</p>
            %%[if @invalid != 1 then]%%
            <form role="form" id="new_session" class="card-row" action="" accept-charset="UTF-8" method="post">
               <input type="hidden" name="SubscriberKey" id="SubscriberKey" value="%%_subscriberkey%%">
               <input type="hidden" name="update" id="update" value="update">
               <div class="form-row">
                  <input type="hidden" />
                  <div class="preference">
                     <div class="options">
                        <table>
                           <tr>
                              <table>
                                 <tr>
                                    <table>
                                       <tr>
                                          <td>
                                             <div class="form-item form-type-option">
                                                <input type="checkbox" class="" id="newsletter" name="newsletter" value="1" 
                                                <ctrl:eval>prefChecked('newsletter')</ctrl:eval>
                                                >
                                                <label for="newsletter">Newsletter</label>
                                             </div>
                                          </td>
                                       </tr>
                                    </table>
                                 </tr>
                              </table>
                              <table>
                                 <tr>
                                    <table>
                                       <tr>
                                          <td>
                                             <div class="form-item form-type-option">
                                                <input type="checkbox" class="" id="nrl_partners" name="nrl_partners" value="1" 
                                                <ctrl:eval>prefChecked('nrl_partners')</ctrl:eval>
                                                >
                                                <label for="nrl_partners">NRL Partners</label>
                                             </div>
                                          </td>
                                       </tr>
                                    </table>
                                 </tr>
                              </table>
                              <table>
                                 <tr>
                                    <table>
                                       <tr>
                                          <td>
                                             <div class="form-item form-type-option">
                                                <input type="checkbox" class="" id="participation" name="participation" value="1" 
                                                <ctrl:eval>prefChecked('participation')</ctrl:eval>
                                                >
                                                <label for="participation">Participation</label>
                                             </div>
                                          </td>
                                       </tr>
                                    </table>
                                 </tr>
                              </table>
                              <table>
                                 <tr>
                                    <table>
                                       <tr>
                                          <td>
                                             <div class="form-item form-type-option">
                                                <input type="checkbox" class="" id="SMS" name="SMS" value="1" 
                                                <ctrl:eval>prefChecked('SMS')</ctrl:eval>
                                                >
                                                <label for="SMS">SMS</label>
                                             </div>
                                          </td>
                                       </tr>
                                    </table>
                                 </tr>
                                 <br>
                                 <br>
                              </table>
                              <table>
                                 <tr>
                                    <td>
                                       <p class="explainer">Unsubscribe from all email and SMS subscriptions.</p>
                                       <div class="options">
                                       </div>
                                    <td>
                                 <tr>
                              </table>
                              <table>
                                 <tr>
                                    <table>
                                       <tr>
                                          <td>
                                             <div class="form-item form-type-option">
                                                <input type="checkbox" class="" id="Unsubscribed" name="Unsubscribed" value="1" 
                                                <ctrl:eval>prefChecked('Unsubscribed')</ctrl:eval>
                                                >
                                                <label for="Unsubscribed">Unsubscribe</label>
                                             </div>
                                          </td>
                                       </tr>
                                    </table>
                                 </tr>
                              </table>
                           </tr>
                        </table>
                     </div>
                  </div>
                  <div class="action-centre">
                     <div class="buttons">
                        <input  class="save-button" type="submit" name="commit" value="update" />
                        <p>
                           <a class="cancel" href="https://www.nrl.com">Cancel</a>
                        </p>
                     </div>
                  </div>
            </form>
            %%[else]%%
            <form role="form" id="new_session" class="card-row" action="/identity/sessions" accept-charset="UTF-8" method="post">
            <input type="hidden" name="SubscriberKey" id="SubscriberKey" value="%%=v(@e)=%%">
            <div class="form-row">
            <label class="form-label" for="mobile_number">
            We could not update your preferences due to a system error. <br>
            Our developer team has been notified and are looking into the issue. <br>
            Please try again at a later time.</label>
            </div>
            </form>
            %%[ endif ]%%
            </div>
         </div>
      </div>
      <div class="content">
         <div class="block-title">
            <h2>
               Privacy
            </h2>
         </div>
         <div class="content-wrapper">
            <div class="privacy-notices">
               <p class="pref-centre_help-text">
                  Please be aware that you may have provided your information to other entities on the NRL Network who may be in a position to contact you. Should you no longer wish to hear from them you will need to liaise with them directly to manage your communication preferences.
               </p>
               <p>
                  <a class="o-content-link" href="https://www.nrl.com/privacy-policy" target="_blank">Privacy&nbsp;Policy</a>
               </p>
            </div>
         </div>
      </div>
         <footer>
            <div class="home-link">
               <a class="no-style" href="https://www.nrl.com.au/">Home</a>
            </div>
            <div class="help-link">
               <a class="no-style" href="https://help.nrl.com/">Help &amp; Contact</a>
            </div>
            <div class="app-links">
               Get the app for
               <a href="https://play.google.com/store/apps/details?id=com.telstra.nrl&hl=en_AU"><img class="android" alt="Android icon" src="https://image.e.amaysim.com.au/lib/fe941573726c077875/m/1/c26ab4fb-1c1e-4f69-b68b-51db6ab3a1dc.png"></a> and
               <a href="https://itunes.apple.com/au/app/nrl-official-app/id442363523?mt=8"><img class="apple" alt="Apple icon" src="https://image.e.amaysim.com.au/lib/fe941573726c077875/m/1/b248fc0d-b717-49b6-9316-783f6165037d.png"></a>
            </div>
            <div class="social-links">
               <a href="https://www.facebook.com/nrl/" target="_blank">
               <img class="facebook" alt="amaysim Facebook" src="http://image.nrl.com/lib/fe90137276650c7f7d/m/1/8c2d7421-4437-4e13-8a78-c9c6fdaf4d99.png">
               </a>
               <a href="https://twitter.com/NRL" target="_blank">
               <img class="twitter" alt="amaysim Twitter" src="http://image.nrl.com/lib/fe90137276650c7f7d/m/1/a74c0d8a-84cf-4627-8dcb-38fbf1c3af2b.png">
               </a>
               <a href="https://www.instagram.com/nrl/?hl=en" target="_blank">
               <img class="instagram" alt="amaysim Instagram" src="http://image.nrl.com/lib/fe90137276650c7f7d/m/1/e37f2bf3-a767-4ae2-8604-931d16f1c68b.png">
               </a>
               <a href="https://www.youtube.com/user/NRL" target="_blank">
               <img class="youtube" alt="amaysim YouTube" src="http://image.nrl.com/lib/fe90137276650c7f7d/m/1/b326d442-b6db-44e7-a956-709f46f615a7.png">
               </a>
            </div>
            <div class="copyright">
               <small>&copy; Copyright %%xtyear%% National Rugby League</small>
            </div>
         </footer>
      <script type="text/javascript">
         var checked = [];
         $('input:checkbox').on('click', function(e) {
             if (this.id == 'Unsubscribed') {
                 if ($(this).is(':checked')) {
                     $('input:checkbox:checked').each(function(key, value) {
                         if (this.id != 'Unsubscribed') {
                             $(this).prop("checked", false);
                             checked.push(this);
                         }
                     });
                 } else {
                     if (checked.length > 0) {
                         $.each(checked, function(key, value) {
                             $(value).prop("checked", true);
                             checked = [];
                             console.log('moo')
                         });
                     } else {
                         $('input:checkbox').each(function(key, value) {
                             if (this.id != 'Unsubscribed') {
                                 $(this).prop("checked", true);
                                 checked = [];
                                 console.log('nooooooo')
                             }
                         });
                     }
                 }
             } else {
                 $('#Unsubscribed').prop("checked", false);
                 checked = [];
             }
         });
      </script>
   </body>
</html>